name: Android Build ğŸ“±

on: [push, pull_request]

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0  # Need full history for version bump script

      # Step 2: Bump version automatically
      - name: ğŸ”¢ Bump version
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        id: bump_version
        run: |
          .github/scripts/bump-version.sh

      - name: ğŸ’¾ Commit version bump
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add ProjectSettings/ProjectSettings.asset
          git commit -m "chore: bump version to ${{ steps.bump_version.outputs.new_version }} [skip ci]" || echo "No version changes to commit"
          git push

      # Step 4: Setup Git LFS Cache
      - name: ğŸ“‹ Create LFS file list
        run: git lfs ls-files -l | cut -d' ' -f1 | sort > .lfs-assets-id

      - name: ğŸ’¾ Restore LFS cache
        uses: actions/cache@v5
        id: lfs-cache
        with:
          path: .git/lfs
          key: ${{ runner.os }}-lfs-${{ hashFiles('.lfs-assets-id') }}

      - name: ğŸ“¦ Pull LFS files
        run: |
          git lfs pull
          git add .
          git reset --hard

      # Step 5: Cache Unity Library (automatically restored and saved)
      - name: ğŸ“š Cache Unity Library
        uses: actions/cache@v5
        with:
          path: Library
          key: Library-${{ runner.os }}-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-${{ runner.os }}-
            Library-

      # Step 6: Build
      - name: ğŸ”¨ Build Android project
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: Android
          allowDirtyBuild: true

      # Step 7: Upload
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Android-Build
          path: build

      # Step 8: Extract version from Unity project
      - name: ğŸ·ï¸ Extract version
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        id: version
        run: |
          VERSION=$(grep "bundleVersion:" ProjectSettings/ProjectSettings.asset | sed 's/.*bundleVersion: //')
          SHORT_SHA=$(git rev-parse --short HEAD)
          RELEASE_VERSION="v${VERSION}-${SHORT_SHA}"
          echo "version=${RELEASE_VERSION}" >> $GITHUB_OUTPUT
          echo "unity_version=${VERSION}" >> $GITHUB_OUTPUT

      # Step 9: Create GitHub Release
      - name: ğŸš€ Create Release
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body: |
            ## ğŸ“± Android Build - Version ${{ steps.version.outputs.unity_version }}

            ### ğŸ“‹ Build Info
            - **Unity Version**: ${{ steps.version.outputs.unity_version }}
            - **Commit**: ${{ github.sha }}
            - **Branch**: ${{ github.ref_name }}
            - **Build Date**: ${{ github.event.head_commit.timestamp }}

            ### ğŸ“ Changes
            ${{ github.event.head_commit.message }}

            ### ğŸ“¥ Download
            Baixe o APK anexo abaixo para instalar no seu dispositivo Android.
          files: |
            build/Android/*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
