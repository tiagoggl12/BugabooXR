name: Self-Hosted Build üñ•Ô∏è

on:
  # Permite execu√ß√£o manual do workflow
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        default: 'iOS'
        type: choice
        options:
          - iOS
          - Android
          - Both
      upload_artifacts:
        description: 'Upload build artifacts'
        required: false
        default: true
        type: boolean
      create_release:
        description: 'Create GitHub Release with APK'
        required: false
        default: false
        type: boolean

  # Tamb√©m pode ser acionado por push (comentado por padr√£o)
  # push:
  #   branches: [ main, develop ]

jobs:
  build:
    name: Build on Self-Hosted Runner
    runs-on: [self-hosted, macOS]

    steps:
      # Step 1: Checkout repository
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      # Step 2: Setup Git LFS
      - name: üìã Create LFS file list
        run: git lfs ls-files -l | cut -d' ' -f1 | sort > .lfs-assets-id

      - name: üì¶ Pull LFS files
        run: |
          git lfs pull
          git add .
          git reset --hard

      # Step 2.5: Extract version from Unity project
      - name: üìã Extract project version
        id: version
        run: |
          # Extrair vers√£o do ProjectSettings.asset
          VERSION=$(grep -E "bundleVersion:" ProjectSettings/ProjectSettings.asset | sed 's/.*bundleVersion: //')

          if [ -z "$VERSION" ]; then
            VERSION="0.0.1"
            echo "‚ö†Ô∏è Vers√£o n√£o encontrada, usando default: $VERSION"
          else
            echo "‚úÖ Vers√£o do projeto: $VERSION"
          fi

          # Criar tag √∫nica com timestamp
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          TAG_NAME="v${VERSION}-${TIMESTAMP}"

          echo "version=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "unity_version=$VERSION" >> $GITHUB_OUTPUT
          echo "üìå Tag da release: $TAG_NAME"

      # Step 3: Display system info
      - name: üíª Display system info
        run: |
          echo "üñ•Ô∏è  System Information:"
          echo "Runner: $(hostname)"
          echo "OS: $(sw_vers -productName) $(sw_vers -productVersion)"
          echo "Architecture: $(uname -m)"
          echo "CPU: $(sysctl -n machdep.cpu.brand_string)"
          echo "Memory: $(sysctl -n hw.memsize | awk '{print $0/1024/1024/1024 " GB"}')"
          echo "Disk space:"
          df -h .
          echo ""
          echo "üîß Unity Installation:"
          if [ -d "/Applications/Unity/Hub/Editor" ]; then
            ls -la /Applications/Unity/Hub/Editor/ | grep "^d" || echo "No Unity versions found"
          else
            echo "Unity Hub not found at default location"
          fi

      # Step 3.5: Find Unity path
      - name: üîç Detect Unity installation
        id: unity
        run: |
          # Procurar por instala√ß√µes do Unity
          UNITY_BASE="/Applications/Unity/Hub/Editor"

          if [ -d "$UNITY_BASE" ]; then
            # Pegar a primeira vers√£o encontrada
            UNITY_VERSION=$(ls -1 "$UNITY_BASE" | grep -v "^\\." | head -n1)

            if [ -n "$UNITY_VERSION" ]; then
              UNITY_PATH="$UNITY_BASE/$UNITY_VERSION/Unity.app/Contents/MacOS/Unity"

              if [ -f "$UNITY_PATH" ]; then
                echo "‚úÖ Unity encontrado: $UNITY_VERSION"
                echo "path=$UNITY_PATH" >> $GITHUB_OUTPUT
                echo "found=true" >> $GITHUB_OUTPUT
                echo "version=$UNITY_VERSION" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi
          fi

          echo "‚ùå Unity n√£o encontrado!"
          echo "found=false" >> $GITHUB_OUTPUT
          exit 1

      # Step 4: Build iOS (if selected)
      - name: üçé Build iOS Xcode project
        if: (github.event.inputs.platform == 'iOS' || github.event.inputs.platform == 'Both') && steps.unity.outputs.found == 'true'
        run: |
          echo "üî® Building iOS project with Unity ${{ steps.unity.outputs.version }}..."

          # Limpar build anterior
          rm -rf build/iOS

          "${{ steps.unity.outputs.path }}" \
            -quit \
            -batchmode \
            -nographics \
            -silent-crashes \
            -logFile "$(pwd)/build-ios.log" \
            -projectPath "$(pwd)" \
            -buildTarget iOS \
            -executeMethod BuildCommand.PerformBuild || {
              echo "‚ö†Ô∏è  Build command failed, checking log..."
              cat build-ios.log
              exit 1
            }

          echo ""
          echo "üìÑ Build log (√∫ltimas 50 linhas):"
          tail -n 50 build-ios.log || echo "No log file found"

          echo ""
          if [ -d "build/iOS" ]; then
            echo "‚úÖ iOS build created successfully!"
            ls -lah build/iOS
          else
            echo "‚ùå iOS build directory not found!"
            exit 1
          fi

      # Step 5: Build Android (if selected)
      - name: ü§ñ Build Android APK
        if: (github.event.inputs.platform == 'Android' || github.event.inputs.platform == 'Both') && steps.unity.outputs.found == 'true'
        run: |
          echo "üî® Building Android project with Unity ${{ steps.unity.outputs.version }}..."

          # Limpar build anterior
          rm -rf build/Android

          "${{ steps.unity.outputs.path }}" \
            -quit \
            -batchmode \
            -nographics \
            -silent-crashes \
            -logFile "$(pwd)/build-android.log" \
            -projectPath "$(pwd)" \
            -buildTarget Android \
            -executeMethod BuildCommand.PerformBuild || {
              echo "‚ö†Ô∏è  Build command failed, checking log..."
              cat build-android.log
              exit 1
            }

          echo ""
          echo "üìÑ Build log (√∫ltimas 50 linhas):"
          tail -n 50 build-android.log || echo "No log file found"

          echo ""
          if [ -d "build/Android" ]; then
            echo "‚úÖ Android build created successfully!"
            ls -lah build/Android
          else
            echo "‚ùå Android build directory not found!"
            exit 1
          fi

      # Step 6: Upload artifacts (optional)
      - name: üì§ Upload iOS build
        if: (github.event.inputs.platform == 'iOS' || github.event.inputs.platform == 'Both') && github.event.inputs.upload_artifacts == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: iOS-Build-SelfHosted
          path: build/iOS
          if-no-files-found: warn

      - name: üì§ Upload Android build
        if: (github.event.inputs.platform == 'Android' || github.event.inputs.platform == 'Both') && github.event.inputs.upload_artifacts == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: Android-Build-SelfHosted
          path: build/Android
          if-no-files-found: warn

      # Step 6.5: Create GitHub Release (if enabled)
      - name: üöÄ Create Android Release
        if: github.event.inputs.create_release == 'true' && (github.event.inputs.platform == 'Android' || github.event.inputs.platform == 'Both')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body: |
            ## üì± Android Build - Version ${{ steps.version.outputs.unity_version }}

            ### üìã Build Info
            - **Unity Version**: ${{ steps.version.outputs.unity_version }}
            - **Commit**: ${{ github.sha }}
            - **Branch**: ${{ github.ref_name }}
            - **Build Date**: ${{ github.event.repository.updated_at }}

            ### üì• Download
            Baixe o APK anexo abaixo para instalar no seu dispositivo Android.
          files: |
            build/Android/*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 7: Build summary
      - name: üìä Build Summary
        if: always()
        run: |
          echo "## üéâ Build completed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: ${{ github.event.inputs.platform || 'Not specified' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Runner**: $(hostname)" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "build" ]; then
            echo "### üì¶ Build Output" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            ls -lah build/ >> $GITHUB_STEP_SUMMARY || echo "No build directory" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      # Step 8: Cleanup (opcional - descomente se necess√°rio)
      # - name: üßπ Cleanup
      #   if: always()
      #   run: |
      #     # Limpar arquivos tempor√°rios se necess√°rio
      #     rm -f build-*.log
      #     rm -f .lfs-assets-id
