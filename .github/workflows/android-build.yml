name: Android Build ðŸ“±

on: [push, pull_request]

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest
    steps:
      # Step 0: Check disk space
      - name: ðŸ’½ Check initial disk space
        run: |
          echo "=== Disk space BEFORE cleanup ==="
          df -h
          echo ""
          echo "=== Largest directories ==="
          sudo du -h --max-depth=1 /usr 2>/dev/null | sort -hr | head -10

      # Step 1: Free up disk space
      - name: ðŸ§¹ Free up disk space
        run: |
          echo "Removing .NET SDK..."
          sudo rm -rf /usr/share/dotnet
          echo "Removing Android SDK..."
          sudo rm -rf /usr/local/lib/android
          echo "Removing GHC/Haskell..."
          sudo rm -rf /opt/ghc
          echo "Removing CodeQL..."
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          echo "Cleaning Docker images..."
          sudo docker image prune --all --force
          echo ""
          echo "=== Disk space AFTER cleanup ==="
          df -h

      # Step 1: Checkout
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      # Step 2: Setup Git LFS Cache
      - name: ðŸ“‹ Create LFS file list
        run: git lfs ls-files -l | cut -d' ' -f1 | sort > .lfs-assets-id

      - name: ðŸ’¾ Restore LFS cache
        uses: actions/cache@v5
        id: lfs-cache
        with:
          path: .git/lfs
          key: ${{ runner.os }}-lfs-${{ hashFiles('.lfs-assets-id') }}

      - name: ðŸ“¦ Pull LFS files
        run: |
          git lfs pull
          git add .
          git reset --hard

      # Step 3: Activate Unity License
      - name: ðŸ”‘ Activate Unity License
        uses: game-ci/unity-activate@v2
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}

      # Step 4: Cache Unity Library (automatically restored and saved)
      - name: ðŸ“š Cache Unity Library
        uses: actions/cache@v5
        with:
          path: Library
          key: Library-${{ runner.os }}-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-${{ runner.os }}-
            Library-

      # Step 5: Build
      - name: ðŸ”¨ Build Android project
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: Android
          allowDirtyBuild: true

      # Step 6: Upload
      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Android-Build
          path: build
