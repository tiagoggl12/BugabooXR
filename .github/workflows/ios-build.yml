name: iOS Build ðŸ“±

on: [push, pull_request]

jobs:
  build:
    name: Build iOS Xcode Project
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      # Step 2: Setup Git LFS Cache
      - name: ðŸ“‹ Create LFS file list
        run: git lfs ls-files -l | cut -d' ' -f1 | sort > .lfs-assets-id

      - name: ðŸ’¾ Restore LFS cache
        uses: actions/cache@v5
        id: lfs-cache
        with:
          path: .git/lfs
          key: ${{ runner.os }}-lfs-${{ hashFiles('.lfs-assets-id') }}

      - name: ðŸ“¦ Pull LFS files
        run: |
          git lfs pull
          git add .
          git reset --hard

      # Step 3: Cache Unity Library (automatically restored and saved)
      - name: ðŸ“š Cache Unity Library
        uses: actions/cache@v5
        with:
          path: Library
          key: Library-${{ runner.os }}-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-${{ runner.os }}-
            Library-

      # Step 4: Build
      - name: ðŸ”¨ Build iOS Xcode project
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: iOS
          allowDirtyBuild: true

      # Step 5: Upload artifacts
      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iOS-Xcode-Build
          path: build

      # Step 6: Deploy to xcode-project branch
      - name: ðŸš€ Deploy to xcode-project branch
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Fetch the xcode-project branch
          git fetch origin xcode-project || git checkout --orphan xcode-project

          # Create a temporary directory for the new content
          TEMP_DIR=$(mktemp -d)

          # Copy the iOS build to temp directory
          cp -r build/iOS/* "$TEMP_DIR/"

          # Switch to xcode-project branch
          git checkout xcode-project || git checkout --orphan xcode-project

          # Remove all existing content
          git rm -rf . || true
          rm -rf * .* 2>/dev/null || true

          # Copy the new build content
          cp -r "$TEMP_DIR"/* .

          # Add all files
          git add -A

          # Commit with build info
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          git commit -m "iOS Build from commit ${SHORT_SHA}" \
                     -m "Source commit: ${{ github.sha }}" \
                     -m "Build date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" || true

          # Push to xcode-project branch
          git push origin xcode-project --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
